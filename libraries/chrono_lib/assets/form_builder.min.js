document.addEventListener("DOMContentLoaded",(function(event){let count=0;document.querySelectorAll(".form_item").forEach(item=>{parseInt(item.dataset.pid)>count&&(count=parseInt(item.dataset.pid))}),document.querySelectorAll(".form_page").forEach(item=>{parseInt(item.dataset.pid)>count&&(count=parseInt(item.dataset.pid))}),count++;let buildPagesCount=function(){let pcount={};document.querySelector(".form_designer").querySelectorAll(".page_box").forEach((page,key)=>{let pg=page.querySelector("input[name$='[pagegroup]']").value;Object.hasOwn(pcount,pg)||(pcount[pg]=0),pcount[pg]++,pg.length>0?page.querySelector(".page_counter").innerHTML=pg+" "+pcount[pg]:page.querySelector(".page_counter").innerHTML=pcount[pg]})},initBehaviorsSelect=function(parent){parent.querySelectorAll("select[data-behaviors]").forEach(select=>{select.addEventListener("optionSelected",e=>{const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let behavior=Nui.Core.create_element(this.responseText);select.closest(".config").querySelector(".behaviors_list").append(behavior),Nui.Accordion.getInstance(select.closest(".config").querySelector(".behaviors_list")).init(),Nui_boot(behavior)}},xhttp.open("GET",document.querySelector(".form_designer").getAttribute("data-url")+"&action=load_behavior&id="+select.closest(".draggable").dataset.pid+"&behavior="+e.detail+"&type="+select.closest(".draggable").querySelector("[name$='[type]']").value+"&name="+select.closest(".draggable").querySelector("[name$='[name]']").value),xhttp.send()}),select.addEventListener("optionUnselected",e=>{select.closest(".draggable").querySelector(".behavior_config[data-type='"+e.detail+"']").remove()})})},setPageHeight=function(page){let height=0;[...page.children].filter(e=>e.matches("[data-tab]")).forEach(tab=>{tab.style.display="block !important";let dimensions=tab.getBoundingClientRect();tab.style.display="",dimensions.height>height&&(height=dimensions.height)}),[...page.children].filter(e=>e.matches("[data-tab]")).forEach(tab=>{tab.style.minHeight=height+"px"})},setPagesHeights=function(){document.querySelector(".form_designer").querySelectorAll(".page_box").forEach((page,k)=>{setPageHeight(page)})};buildPagesCount(),initBehaviorsSelect(document),setPagesHeights(),document.querySelector(".add_page").addEventListener("click",e=>{let pageClone=document.querySelector(".page_box").cloneNode(!0),pid=pageClone.querySelector('[name$="[id]"]').value;pageClone.querySelector('[name$="[id]"]').value=count,pageClone.querySelectorAll('[name^="elements['+pid+']"]').forEach(field=>{field.setAttribute("name",field.getAttribute("name").replace("["+pid+"]","["+count+"]"))}),pageClone.querySelector('[name^="elements['+count+'][title]"]').value="Page"+count,pageClone.querySelector('[name^="elements['+count+'][alias]"]').value="page"+count,pageClone.querySelectorAll("[data-pid]").forEach(parea=>{parea.dataset.pid=count,[...parea.children].forEach(child=>{child.matches(".draggable")&&child.remove()})}),pageClone.querySelectorAll("div").forEach(parea=>{parea.hasAttribute("style")&&parea.setAttribute("style","min-height:200px")}),document.querySelector(".form_designer").append(pageClone),Nui_boot(pageClone),count++,buildPagesCount()}),new Nui.Draggables(".page_box",".form_designer",{draggerSelector:".drag_page",onClone:draggable=>(document.querySelector(".form_designer").querySelectorAll(".page_box").forEach(item=>{item.classList.add("disabled")}),Nui.Core.create_element('<div class="nui segment bordered rounded slate bold">Page</div>')),onDrop:draggable=>{buildPagesCount(),document.querySelector(".form_designer").querySelectorAll(".page_box").forEach(item=>{item.classList.remove("disabled")})}}),new Nui.Draggables(".draggable.form_item",".droppable",{draggerSelector:".drag_item",sortableSelector:".draggable",onDrop:draggable=>{draggable.querySelector('[name$="[parent]"]').value=draggable.parentElement.getAttribute("data-pid"),draggable.querySelector('[name$="[section]"]').value=draggable.parentElement.getAttribute("data-section")},onClone:draggable=>Nui.Core.create_element('<div class="nui segment bordered rounded slate bold">'+draggable.dataset.title+"</div>")}),new Nui.Draggables(".draggable.original_item",".droppable",{sortableSelector:".draggable",onDrop:clone=>{const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let codePieces=this.responseText.split("\x3c!--config--\x3e"),item=Nui.Core.create_element(codePieces[0]);clone.replaceWith(item),Nui_boot(item),initBehaviorsSelect(item),count++,setPageHeight(item.closest(".page_box"))}};let link=document.querySelector(".form_designer").getAttribute("data-url")+"&action=load_element&type="+clone.dataset.type+"&name="+clone.dataset.name+"&id="+count+"&pid="+clone.closest("[data-pid]").dataset.pid;link=link+"&section="+clone.closest("[data-section]").dataset.section,xhttp.open("GET",link),xhttp.send()},onEnterDroppable:(draggable,droppable)=>{document.querySelectorAll(".form_item").forEach(item=>{item.querySelector(".actions").classList.add("invisible")})},onExitDroppable:(draggable,droppable)=>{document.querySelectorAll(".form_item").forEach(item=>{item.querySelector(".actions").classList.remove("invisible")})}}),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".remove_item")){let item=e.target.closest(".draggable");null!=item&&item.remove()}})),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".edit_item")){let item=e.target.closest(".draggable");null!=item&&item.classList.toggle("selected")}})),document.addEventListener("mouseover",(function(e){let item=e.target.closest(".form_item");null!=item&&[...item.children].filter(e=>e.matches(".actions"))[0].classList.remove("hidden")})),document.addEventListener("mouseout",(function(e){let item=e.target.closest(".form_item");null!=item&&[...item.children].filter(e=>e.matches(".actions"))[0].classList.add("hidden")})),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".remove_page")){let item=e.target.closest(".page_box");null!=item&&item.remove()}})),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".minimize_page")){let item=e.target.closest(".page_box");null!=item&&(item.classList.add("minimized"),item.querySelector("input[name$='[minimized]']").value=1,item.querySelector(".maximize_page").classList.remove("hide_maximized"))}})),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".maximize_page")){let item=e.target.closest(".page_box");null!=item&&(item.querySelector("input[name$='[minimized]']").value="",item.querySelector(".maximize_page").classList.add("hide_maximized"),item.classList.remove("minimized"))}})),document.querySelectorAll(".page_box").forEach(page_box=>{"1"==page_box.querySelector("input[name$='[minimized]']").value?page_box.classList.add("minimized"):page_box.querySelector(".maximize_page").classList.add("hide_maximized")}),document.addEventListener("optionSelected",e=>{if(e.target.matches("[data-formbuilder_dynamicevents]")&&(dropdown=e.target,event_name=e.detail,id=dropdown.getAttribute("data-formbuilder_dynamicevents"),!dropdown.closest("[data-pid='"+id+"']").querySelector('[data-pid="'+id+'"][data-section="'+event_name+'"]'))){let color="blue",title=event_name;dropdown.querySelector('option[value="'+event_name+'"][data-html]')&&(new_label=Nui.Core.create_element(dropdown.querySelector('option[value="'+event_name+'"][data-html]').getAttribute("data-html")),color=new_label.getAttribute("class").replace("nui label",""),title=new_label.innerText),new_event=Nui.Core.create_element('<div class="nui p1 flex vertical spaced bottom block dashed bordered rounded droppable sortable '+color+'" data-pid="'+id+'" data-section="'+event_name+'" data-title="'+title+'" style="min-height:50px;" data-hint=""></div>'),dropdown.closest("[data-pid='"+id+"']").append(new_event)}}),document.addEventListener("optionUnselected",e=>{e.target.matches("[data-formbuilder_dynamicevents]")&&(dropdown=e.target,event_name=e.detail,id=dropdown.getAttribute("data-formbuilder_dynamicevents"),dropdown.closest("[data-pid='"+id+"']").querySelector("[data-section='"+event_name+"']").remove())}),document.addEventListener("input",e=>{e.target.matches("input[name$='[label]']")&&(label=e.target,label.closest(".fields")&&label.closest(".fields").querySelector("input[name$='[fieldname]']")&&label.closest("form").hasAttribute("data-autofieldname")&&(label.closest(".fields").querySelector("input[name$='[fieldname]']").value=label.value.toLowerCase().replace(/^[^a-zA-Z]+/,"").replace(/[^a-z0-9_-]+/g,"_").replace(/_+$/,"")))}),document.addEventListener("change",e=>{e.target.matches("input[name$='[pagegroup]']")&&buildPagesCount()})}));